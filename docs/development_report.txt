Отчет о разработке LumeLines: Daily Blocks

Дата: 2026-01-02

1) Цели и ограничения
- Классический block puzzle на поле 10x10 без серверов и онлайн-зависимостей.
- Полная играбельность при отсутствии рекламы (adblock/unfilled/error).
- Монетизация только через CrazyGames SDK (midgame + rewarded) по правилам платформы.
- Минимальная сложность реализации и поддержки.

2) Техстек и обоснование
- TypeScript + Vite: быстрый дев-цикл, строгая типизация, простая сборка.
- Canvas2D: самый простой и быстрый для одного разработчика рендер без зависимостей.
- Vitest: быстрые и стабильные юнит-тесты для core-логики.

3) Архитектура и модули
- src/core: чистая игровая логика без UI.
  - board: проверка размещения фигур и доступности ходов.
  - scoring/game: подсчет очков, комбо, токенов.
  - generator/rng: генерация фигур с анти-фрустрацией.
  - daily: deterministic seed для Daily Challenge.
  - cooldowns: правила rewarded-кулдаунов.
- src/app: UI, рендер, состояния и ввод.
  - App: оркестрация экранов, сессий и SDK.
  - Renderer: отрисовка поля, фигур, подсветок и эффекта glow.
  - GameSession: состояние партии и переходы.
  - ScreenManager/Toast/DebugOverlay: экраны, уведомления, debug-инфо.
  - AudioManager: воспроизведение музыки и SFX с отдельными настройками.
- src/services: интеграции.
  - crazygames: SDK calls (loading, gameplay, ads, adblock, happytime).
  - storage: Data Module с fallback на localStorage.
- src/utils: логирование (INFO/WARN/ERROR) и форматирование.

4) Игровой цикл
- Игрок получает 3 фигуры и размещает их на поле 10x10.
- Линии (ряды/колонки) очищаются при полном заполнении.
- Раунд заканчивается, когда нельзя поставить ни одну фигуру.

5) Скоринг и комбо (реализовано дословно по ТЗ)
- Размещение: +5 за каждую занятую клетку.
- Очистка линии: +120 за каждую линию.
- Бонус за мульти-очистку: +80 * (L - 1), где L — число очищенных линий за ход.
- Комбо-множитель: старт x1.00, +0.25 за ход с очисткой, максимум x2.50.
- Ход без очистки сбрасывает комбо к x1.00.
- Комбо умножает только очки за очистки, очки размещения не умножаются.

6) Экономика
- Tokens за раунд: max(1, floor(score/1500)).
- Бонусы: +2 за новый bestScore; +3 за первую попытку Daily в день.
- Темы: 20 / 35 / 50 / 70 tokens.

7) Rewarded и midgame
- Midgame показывается только после раунда (Results) или при смене режима.
- Rewarded выдаются только по кнопке игрока:
  - Continue: 1 раз за раунд, score >= 800, после просмотра выдаются фигуры [1x1, 1x2, 2x2], комбо сбрасывается.
  - Double Tokens: 1 раз за раунд, tokens >= 2, после просмотра tokens *= 2.
- Глобальный кулдаун rewarded: 90 секунд между любыми запросами.
- Кулдаун Continue: 10 минут между раундами (rewardCooldownUntil).
- AdError/adblock: награда не выдается, показывается “Ad unavailable”, игра продолжается.

8) Генерация фигур и анти-фрустрация
- Набор 16 базовых фигур.
- Первые 10 ходов гарантируют хотя бы 1 размещаемую фигуру из 3.
- Не выдаются 3 “крупные” фигуры подряд (крупность по числу клеток).
- Daily Challenge полностью детерминирован: seed = YYYYMMDD + salt “lumelines_v1”.

9) Управление и мобильная поддержка
- Desktop: drag-and-drop мышью.
- Mobile: drag-and-drop пальцем и режим tap-to-place.
- На canvas установлен touch-action: none, а обработка указателя использует pointer capture, чтобы жесты не ломались в браузере.

10) Экраны и UI
- Boot/Loading, Main Menu, Gameplay, Pause, Results, Themes, Settings.
- Меню показывает название, слоган и текущие показатели.
- Results экран содержит CTA, подсказки rewarded и итоговые токены.
- Settings: отдельные тумблеры для музыки и SFX, а также tap-to-place.

11) Визуальный стиль “Lume”
- Эффект мягкого свечения через Canvas2D (подсветка линий/комбо).
- Минимальные эффекты (альфа/скейл) без тяжелых шейдеров.

12) Аудио
- Используются реальные WAV-файлы вместо синтеза.
- Отдельные настройки музыки и SFX.
- AudioContext активируется на первом пользовательском жесте (политики браузера).
- Легкая вариация питча для “живого” звучания и настройка уровней.

13) Сохранения
- Приоритет CrazyGames Data Module, fallback на localStorage.
- Ключи: bestScore, themesUnlocked, dailyBest_YYYYMMDD, rewardCooldownUntil,
  runsCount, settings, tokens.

14) Логи и отладка
- Логируются ключевые события: startSession/startRun/endRun, adRequested/adStarted/adFinished/adError,
  rewardedUsed/rewardedDenied, purchaseTheme.
- В dev режиме включается debug overlay (FPS/seed/combo/next pieces).

15) Тесты
- 28 юнит-тестов (Vitest): canPlace, applyPlacement/clear, scoring+combo, генератор,
  deterministic daily seed, cooldown rules.
- Команда: npm run test.

16) Сборка и запуск
- Скрипты: dev, build, test, lint.
- VITE_USE_CRAZYGAMES_MOCK управляет использованием mock SDK.
- Сборка в dist/ (готова для загрузки на CrazyGames).

17) Промо-материалы
- promo/metadata.json: title/description/tags.
- promo/screenshots/: Landscape.png, Portrait.png, Square.png, Square2.png.
- promo/promo-images/: placeholder cover/thumb SVG.

18) Текущее состояние и остаток
- Готово: core-логика, UI, SDK-интеграции, сохранения, тесты, сборка, аудио.
- Осталось: smoke-тест на реальном CrazyGames SDK, финальные промо-изображения.

Конец отчета.
